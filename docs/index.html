<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Google API Auth Test</title>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>Тест авторизации Google API</h1>
  <button id="authBtn">Авторизоваться</button>
  <pre id="output"></pre>

  <script>
    const CLIENT_ID = "104760002655-tftfu479sjog0u3qj9oa145a8qo7a9t2.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

    let authInstance;

    function writeLog(msg) {
      const out = document.getElementById('output');
      out.textContent += msg + "\n";
      console.log(msg);
    }

    function initClient() {
      gapi.client.init({
        clientId: CLIENT_ID,
        scope: SCOPES
      }).then(() => {
        authInstance = gapi.auth2.getAuthInstance();
        writeLog("Google API client initialized");

        if (authInstance.isSignedIn.get()) {
          writeLog("Пользователь уже авторизован");
          showUserInfo();
        } else {
          writeLog("Пользователь не авторизован");
        }
      }, (error) => {
        writeLog("Ошибка инициализации клиента: " + JSON.stringify(error));
      });
    }

    function showUserInfo() {
      const user = authInstance.currentUser.get();
      const profile = user.getBasicProfile();
      writeLog("ID пользователя: " + profile.getId());
      writeLog("Имя: " + profile.getName());
      writeLog("Email: " + profile.getEmail());
    }

    function handleAuthClick() {
      if (!authInstance) {
        writeLog("API клиент не инициализирован");
        return;
      }

      if (!authInstance.isSignedIn.get()) {
        authInstance.signIn().then(() => {
          writeLog("Авторизация успешна");
          showUserInfo();
        }).catch(err => {
          writeLog("Ошибка авторизации: " + err.error);
        });
      } else {
        writeLog("Пользователь уже авторизован");
        showUserInfo();
      }
    }

    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    document.getElementById('authBtn').addEventListener('click', () => {
      handleAuthClick();
    });

    // Запускаем загрузку Google API
    handleClientLoad();
  </script>
</body>
</html>
