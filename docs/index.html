const SHEET_ID = '1gW4ZD30gfiZqzT8e2ZATtfFljxHr2tiyMS6l_HEwFEs';
const SHEET_NAME = 'Events';

const CALENDAR_MAP = {
  "master1": "irina.salon11@gmail.com",
  "master2": "primary"
};

function doGet(e) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const events = [];

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (!row[0]) continue;

    events.push({
      id: row[0],
      title: row[1],
      start: row[2],
      end: row[3],
      calendarKey: row[4],
      description: row[5]
    });
  }

  return createCorsOutput(events);
}

function doPost(e) {
  const log = [];
  try {
    log.push('--- START doPost ---');
    log.push('e keys: ' + JSON.stringify(Object.keys(e || {})));
    log.push('e.postData: ' + JSON.stringify(e.postData || {}));

    let body = {};
    if (e.postData && e.postData.contents) {
      body = JSON.parse(e.postData.contents);
      log.push('Parsed body: ' + JSON.stringify(body));
    } else {
      throw new Error("No POST data received");
    }

    const action = body.action;
    log.push('Action: ' + action);
    if (!action) throw new Error("No action specified");

    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);

    if (action === 'create') {
      log.push('--- CREATE ---');
      const calendarKey = body.calendarKey || "master1";
      const calendarId = CALENDAR_MAP[calendarKey];
      log.push('calendarKey: ' + calendarKey);
      log.push('calendarId: ' + calendarId);
      if (!calendarId) throw new Error("Unknown calendar key: " + calendarKey);

      const start = new Date(body.start);
      const end = new Date(body.end);
      log.push('Start: ' + start.toISOString());
      log.push('End: ' + end.toISOString());

      const eventResource = {
        summary: body.title || "Без названия",
        description: body.description || "",
        start: {
          dateTime: start.toISOString(),
          timeZone: Session.getScriptTimeZone()
        },
        end: {
          dateTime: end.toISOString(),
          timeZone: Session.getScriptTimeZone()
        }
      };

      const createdEvent = Calendar.Events.insert(eventResource, calendarId);
      log.push('Created Event ID: ' + createdEvent.id);

      sheet.appendRow([
        createdEvent.id,
        createdEvent.summary,
        createdEvent.start.dateTime,
        createdEvent.end.dateTime,
        calendarKey,
        createdEvent.description || ''
      ]);

      return createCorsOutput({ status: "created", id: createdEvent.id, log });
    }

    else if (action === 'update') {
      log.push('--- UPDATE ---');
      const id = body.id;
      log.push('Update ID: ' + id);
      if (!id) throw new Error("No event id specified for update");

      const calendarKey = body.calendarKey || "master1";
      const calendarId = CALENDAR_MAP[calendarKey];
      log.push('calendarKey: ' + calendarKey);
      log.push('calendarId: ' + calendarId);
      if (!calendarId) throw new Error("Unknown calendar key: " + calendarKey);

      const start = new Date(body.start);
      const end = new Date(body.end);
      log.push('Start: ' + start.toISOString());
      log.push('End: ' + end.toISOString());

      const eventResource = {
        summary: body.title || "Без названия",
        description: body.description || "",
        start: {
          dateTime: start.toISOString(),
          timeZone: Session.getScriptTimeZone()
        },
        end: {
          dateTime: end.toISOString(),
          timeZone: Session.getScriptTimeZone()
        }
      };

      const updatedEvent = Calendar.Events.update(eventResource, calendarId, id);
      log.push('Updated Event ID: ' + updatedEvent.id);

      const data = sheet.getDataRange().getValues();
      let found = false;
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] === id) {
          const row = i + 1;
          sheet.getRange(row, 2).setValue(updatedEvent.summary);
          sheet.getRange(row, 3).setValue(updatedEvent.start.dateTime);
          sheet.getRange(row, 4).setValue(updatedEvent.end.dateTime);
          sheet.getRange(row, 5).setValue(calendarKey);
          sheet.getRange(row, 6).setValue(updatedEvent.description || '');
          found = true;
          log.push('Row updated at: ' + row);
          break;
        }
      }
      if (!found) throw new Error("Event ID not found in sheet");

      return createCorsOutput({ status: "updated", id, log });
    }

    else if (action === 'delete') {
      log.push('--- DELETE ---');
      const id = body.id;
      log.push('Delete ID: ' + id);
      if (!id) throw new Error("No event id specified for delete");

      const data = sheet.getDataRange().getValues();
      let foundRow = -1;
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] === id) {
          foundRow = i + 1;
          break;
        }
      }
      if (foundRow === -1) throw new Error("Event ID not found in sheet");

      const calendarKey = data[foundRow - 1][4];
      const calendarId = CALENDAR_MAP[calendarKey] || CALENDAR_MAP["master1"];
      log.push('calendarKey: ' + calendarKey);
      log.push('calendarId: ' + calendarId);

      Calendar.Events.remove(calendarId, id);
      log.push('Removed event from Calendar');

      sheet.deleteRow(foundRow);
      log.push('Deleted row from Sheet: ' + foundRow);

      return createCorsOutput({ status: "deleted", id, log });
    }

    else {
      throw new Error("Unknown action: " + action);
    }

  } catch (err) {
    log.push('--- ERROR ---');
    log.push(err.stack || err.toString());
    return createCorsOutput({ status: "error", message: err.message || err.toString(), log });
  }
}

function doOptions() {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeader('Access-Control-Allow-Origin', '*')
    .setHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS')
    .setHeader('Access-Control-Allow-Headers', 'Content-Type');
}

function createCorsOutput(obj) {
  const output = ContentService.createTextOutput(JSON.stringify(obj));
  output.setMimeType(ContentService.MimeType.JSON);
  output.setHeader('Access-Control-Allow-Origin', '*');
  output.setHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS');
  output.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  return output;
}

  async function loadEvents() {
    try {
      const response = await fetch(GAS_URL);
      if (!response.ok) throw new Error('Network response was not ok');
      const events = await response.json();
      ec.setOption('events', events);
      updateTitle();
    } catch (error) {
      console.error('Ошибка загрузки событий:', error);
    }
  }

  const calendarEl = document.getElementById("ec");
  const hammer = new Hammer(calendarEl);
  hammer.get("doubletap").set({ interval: 300 });

  hammer.on("doubletap", function () {
    if (lastClickedDate && Date.now() - lastTapTime < 600) {
      ec.setOption("date", lastClickedDate);
      ec.setOption("view", "resourceTimeGridDay");
      updateActiveMode("resourceTimeGridDay");
      updateTitle();
    }
  });

  document.addEventListener("touchstart", e => {
    touchStartX = e.changedTouches[0].screenX;
  });

  document.addEventListener("touchend", e => {
    touchEndX = e.changedTouches[0].screenX;
    let delta = touchEndX - touchStartX;
    if (Math.abs(delta) > 50) {
      if (delta > 0) ec.prev();
      else ec.next();
      updateTitle();
    }
  });

  document.getElementById("modeSwitcher").addEventListener("click", (e) => {
    if (e.target.dataset.view) {
      const currentDate = ec.getOption("date");
      ec.setOption("date", currentDate);
      ec.setOption("view", e.target.dataset.view);
      updateActiveMode(e.target.dataset.view);
      updateTitle();
    }
  });

  document.getElementById("dayFooter").addEventListener("click", (e) => {
    const item = e.target.closest('.day-item');
    if (item && item.dataset.date) {
      ec.setOption("date", item.dataset.date);
      ec.setOption("view", "resourceTimeGridDay");
      updateActiveMode("resourceTimeGridDay");
      updateTitle();
    }
  });

  ec.setOption("dateClick", function(info) {
    lastClickedDate = info.dateStr;
    lastTapTime = Date.now();
  });

  // --- Создание события с синхронизацией на сервер (application/x-www-form-urlencoded)
  function createEventPrompt(selectInfo) {
    const title = prompt("Введите название нового события:", "");
    if (!title) return;

    const params = new URLSearchParams({
      action: "create",
      title: title,
      start: selectInfo.startStr,
      end: selectInfo.endStr,
      resourceId: selectInfo.resource ? selectInfo.resource.id : 1,
      allDay: selectInfo.allDay || false,
      calendarKey: selectInfo.resource ? (selectInfo.resource.title.toLowerCase() === "ирина" ? "master1" : "master2") : "master1"
    });

    fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: params.toString()
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "created") {
        ec.refetchEvents ? ec.refetchEvents() : loadEvents(); // обновляем календарь
      } else {
        alert("Ошибка создания события");
      }
    })
    .catch(err => {
      console.error("Ошибка отправки create:", err);
    });
  }

  // --- Редактирование или удаление события с синхронизацией на сервер (application/x-www-form-urlencoded)
  function editEventPrompt(event) {
    const newTitle = prompt("Редактировать название события:", event.title);
    if (newTitle === null) return;

    if (newTitle === "") {
      if (confirm("Удалить событие?")) {
        const params = new URLSearchParams({
          action: "delete",
          id: event.id
        });
        fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: params.toString()
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === "deleted") {
            ec.refetchEvents ? ec.refetchEvents() : loadEvents();
          } else {
            alert("Ошибка удаления события");
          }
        })
        .catch(err => {
          console.error("Ошибка удаления:", err);
        });
      }
      return;
    }

    // Обновление
    const params = new URLSearchParams({
      action: "update",
      id: event.id,
      title: newTitle,
      start: event.start.toISOString(),
      end: event.end ? event.end.toISOString() : "",
      calendarKey: event.extendedProps?.calendarKey || "master1"
    });

    fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: params.toString()
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "updated") {
        event.setProp("title", newTitle);
      } else {
        alert("Ошибка обновления события");
      }
    })
    .catch(err => {
      console.error("Ошибка отправки update:", err);
    });
  }

  function updateActiveMode(viewName) {
    document.querySelectorAll("#modeSwitcher span").forEach(el => {
      el.classList.toggle("active", el.dataset.view === viewName);
    });
    document.getElementById("dayFooter").style.display = viewName === "resourceTimeGridDay" ? "flex" : "none";
    document.getElementById("monthFooter").style.display = viewName === "resourceTimeGridDay" ? "none" : "flex";
  }

  function updateTitle() {
    const dateStr = ec.getOption("date");
    const date = new Date(dateStr);
    const view = ec.getOption("view");

    const day = date.getDate();
    const dow = date.toLocaleString('default', { weekday: 'long' });
    const monthShort = date.toLocaleString('default', { month: 'short' });

    if (view === "resourceTimeGridDay") {
      document.getElementById("calendarTitle").textContent = `${dow}, ${day} ${monthShort}`;
      document.getElementById("calendarSubtitle").textContent = `Week ${getWeekNumber(date)}`;
      updateDayFooterWithDates(date);
    } else {
      const month = date.toLocaleString('default', { month: 'long' });
      const year = date.getFullYear();
      document.getElementById("calendarTitle").textContent = `${month} ${year}`;
      document.getElementById("calendarSubtitle").textContent = ``;
    }

    updateMonthFooter(date);
  }

  function updateMonthFooter(currentDate) {
    const footer = document.getElementById("monthFooter");
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const today = new Date();
    const currentMonthIndex = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();

    footer.innerHTML = "";

    for (let i = -3; i <= 3; i++) {
      const date = new Date(currentYear, currentMonthIndex + i, 1);
      const index = date.getMonth();
      const year = date.getFullYear();

      const span = document.createElement("span");
      span.textContent = months[index];
      span.dataset.month = index;
      span.classList.toggle("active", i === 0);

      const isTodayMonth = index === today.getMonth() && year === today.getFullYear();
      const isSelected = i === 0;

      if (isTodayMonth && !isSelected) {
        span.classList.add("current-month");
      }

      span.addEventListener("click", () => {
        const newDate = new Date(currentYear, index, 1);
        ec.setOption("date", newDate.toISOString().slice(0, 10));
        ec.setOption("view", "dayGridMonth");
        updateTitle();
      });

      footer.appendChild(span);
    }
  }

  function updateDayFooterWithDates(date) {
    const footer = document.getElementById("dayFooter");
    footer.innerHTML = "";

    const startOfWeek = new Date(date);
    startOfWeek.setDate(date.getDate() - ((date.getDay() + 6) % 7)); // Monday

    for (let i = 0; i < 7; i++) {
      const d = new Date(startOfWeek);
      d.setDate(d.getDate() + i);
      const iso = d.toISOString().slice(0, 10);

      const dow = d.toLocaleString('default', { weekday: 'short' });
      const day = d.getDate();
      const isActive = d.toDateString() === date.toDateString();
      const month = d.toLocaleString('default', { month: 'short' });

      const div = document.createElement("div");
      div.className = "day-item" + (isActive ? " active" : "");
      div.dataset.date = iso;
      div.innerHTML = `
        <div class="circle">
          <div class="day-name">${dow}</div>
          <div class="day-number">${day}</div>
          ${isActive ? `<div class="day-month">${month}</div>` : ""}
        </div>
      `;
      footer.appendChild(div);
    }
  }

  function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  // Загружаем события сразу
  loadEvents();

</script>
</body>
</html>
