<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EventCalendar</title>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png" />
    <link rel="manifest" href="site.webmanifest" />
    <link rel="stylesheet" href="global.css?20231021" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@event-calendar/build@4.5.0/dist/event-calendar.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@event-calendar/build@4.5.0/dist/event-calendar.min.js"></script>
    <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
    <style>
        .ec-timeline .ec-time,
        .ec-timeline .ec-line {
            width: 16px;
        }
        .ec-timeline .ec-time {
            overflow: visible;
        }
        .ec-timeline .ec-time time {
            display: inline-block;
            width: 64px;
            text-align: center;
        }
    </style>
</head>
<body>
<header class="row">
    <button class="toggle-dark-button" title="Toggle dark mode" onclick="document.body.classList.toggle('ec-dark')">
        üåô
    </button>
</header>
<main class="row">
    <div id="ec" class="col"></div>
</main>

<script>
    let touchStartX = 0;
    let touchEndX = 0;
    let blockTap = false;
    let lastClickedDate = null;
    let lastTapTime = 0;
    let ec;

    document.addEventListener("touchstart", function (e) {
        touchStartX = e.changedTouches[0].screenX;
    });

    document.addEventListener("touchend", function (e) {
        touchEndX = e.changedTouches[0].screenX;
        let delta = touchEndX - touchStartX;
        if (Math.abs(delta) > 50) {
            blockTap = true;
            setTimeout(() => (blockTap = false), 400);
            if (delta > 0) {
                ec.prev();
            } else {
                ec.next();
            }
        }
    });

    async function loadEvents() {
        try {
            const response = await fetch("https://script.google.com/macros/s/AKfycbydJnukG6hcd7xUjCSqW1ChBLrJVh9iYCDH4h9OrgeJDW1VjuXUHCcixLjjwavA67U8iQ/exec");
            if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π");
            const events = await response.json();
            return events;
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    async function initCalendar() {
        const events = await loadEvents();

        ec = EventCalendar.create(document.getElementById("ec"), {
            view: "dayGridMonth",
            firstDay: 1,  // –ù–µ–¥–µ–ª—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
            timeFormat: 'H:mm', // 24-—á–∞—Å–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏
            headerToolbar: {
                start: "prev,next today",
                center: "title",
                end: "dayGridMonth,timeGridWeek,timeGridDay,listWeek resourceTimeGridWeek,resourceTimelineWeek",
            },
            resources: [
                { id: 1, title: "–ù–∞—Ç–∞–ª—å—è" },
                { id: 2, title: "–ò—Ä–∏–Ω–∞" },
            ],
            scrollTime: "09:00:00",
            events: events,
            views: {
                timeGridWeek: {
                    pointer: true,
                    slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour24: false },
                },
                resourceTimeGridWeek: {
                    pointer: true,
                    slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour24: false },
                },
                resourceTimelineWeek: {
                    slotDuration: "00:15",
                    slotLabelInterval: "01:00",
                    slotMinTime: "09:00",
                    slotMaxTime: "21:00",
                    slotWidth: 16,
                    slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour24: false },
                },
            },
            dayMaxEvents: true,
            nowIndicator: true,
            selectable: true,
            dateClick: function (info) {
                lastClickedDate = info.dateStr;
                lastTapTime = Date.now();
            },
        });

        const calendarEl = document.getElementById("ec");
        const hammer = new Hammer(calendarEl);
        hammer.get("doubletap").set({ interval: 300 });

        hammer.on("doubletap", function () {
            if (lastClickedDate && Date.now() - lastTapTime < 600) {
                ec.setOption("date", lastClickedDate);
                ec.setOption("view", "resourceTimeGridDay");
            }
            // –ï—Å–ª–∏ –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø –Ω–µ –ø–æ –¥–∞—Ç–µ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        });
    }

    initCalendar();

    // –§—É–Ω–∫—Ü–∏–∏ _pad –∏ createEvents –æ—Å—Ç–∞–≤–∏–ª, –Ω–æ –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è
    function createEvents() {
        let days = [];
        for (let i = 0; i < 7; ++i) {
            let day = new Date();
            let diff = i - day.getDay();
            day.setDate(day.getDate() + diff);
            days[i] = day.getFullYear() + "-" + _pad(day.getMonth() + 1) + "-" + _pad(day.getDate());
        }

        return [
            { start: days[0] + " 00:00", end: days[0] + " 09:00", resourceId: 1, display: "background" },
            { start: days[1] + " 12:00", end: days[1] + " 14:00", resourceId: 2, display: "background" },
            { start: days[2] + " 17:00", end: days[2] + " 24:00", resourceId: 1, display: "background" },
            {
                start: days[0] + " 10:00",
                end: days[0] + " 14:00",
                resourceId: 1,
                title: "The calendar can display background and regular events",
                color: "#FE6B64",
            },
            {
                start: days[1] + " 16:00",
                end: days[2] + " 08:00",
                resourceId: 2,
                title: "An event may span to another day",
                color: "#B29DD9",
            },
            {
                start: days[2] + " 09:00",
                end: days[2] + " 13:00",
                resourceId: 2,
                title: "Events can be assigned to resources and the calendar has the resources view built-in",
                color: "#779ECB",
            },
            { start: days[3] + " 14:00", end: days[3] + " 20:00", resourceId: 1, title: "", color: "#FE6B64" },
            {
                start: days[3] + " 15:00",
                end: days[3] + " 18:00",
                resourceId: 1,
                title: "Overlapping events are positioned properly",
                color: "#779ECB",
            },
            {
                start: days[5] + " 10:00",
                end: days[5] + " 16:00",
                resourceId: 2,
                title: { html: "You have complete control over the <i><b>display</b></i> of events‚Ä¶" },
                color: "#779ECB",
            },
            {
                start: days[5] + " 14:00",
                end: days[5] + " 19:00",
                resourceId: 2,
                title: "‚Ä¶and you can drag and drop the events!",
                color: "#FE6B64",
            },
            { start: days[5] + " 18:00", end: days[5] + " 21:00", resourceId: 2, title: "", color: "#B29DD9" },
            {
                start: days[1],
                end: days[3],
                resourceId: 1,
                title: "All-day events can be displayed at the top",
                color: "#B29DD9",
                allDay: true,
            },
        ];
    }

    function _pad(num) {
        let norm = Math.floor(Math.abs(num));
        return (norm < 10 ? "0" : "") + norm;
    }
</script>
</body>
</html>
